<!-- HTML for dev server -->
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Swagger UI</title>
  <link href="https://fonts.googleapis.com/css?family=Open+Sans:400,700|Source+Code+Pro:300,600|Titillium+Web:400,600,700" rel="stylesheet">
  <link rel="stylesheet" type="text/css" href="./dist/swagger-ui.css" >
  <link rel="icon" type="image/png" href="./favicon-32x32.png" sizes="32x32" />
  <link rel="icon" type="image/png" href="./favicon-16x16.png" sizes="16x16" />
  <style>
    html
    {
      box-sizing: border-box;
      overflow: -moz-scrollbars-vertical;
      overflow-y: scroll;
    }

    *,
    *:before,
    *:after
    {
      box-sizing: inherit;
    }

    body
    {
      margin:0;
      background: #fafafa;
    }
  </style>
</head>

<body>
  <div id="swagger-ui"></div>

  <script src="https://poweropenapi.atlassian.net/atlassian-connect/all.js" data-options="resize:true" type="text/javascript"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/yamljs/0.3.0/yaml.min.js" type="text/javascript"></script>
  <script src="/dist/swagger-ui-bundle.js"> </script>
  <script src="/dist/swagger-ui-standalone-preset.js"> </script>
  <script>
    window.onload = function() {
      // Removed by Alan. Doesn't work in this project
      // window["SwaggerUIBundle"] = window["swagger-ui-bundle"]
      // window["SwaggerUIStandalonePreset"] = window["swagger-ui-standalone-preset"]

      // https://stackoverflow.com/questions/901115/how-can-i-get-query-string-values-in-javascript
      function getUrlParameter(name, url) {
        if (!url) url = window.location.href;
        name = name.replace(/[\[\]]/g, "\\$&");
        var regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)"),
          results = regex.exec(url);
        if (!results) return null;
        if (!results[2]) return '';
        return decodeURIComponent(results[2].replace(/\+/g, " "));
      }

      function start(spec) {
        // Build a system
        const ui = SwaggerUIBundle({
          // url: "http://petstore.swagger.io/v2/swagger.json",
          spec: spec,
          dom_id: '#swagger-ui',
          presets: [
            SwaggerUIBundle.presets.apis,
            SwaggerUIStandalonePreset
          ],
          plugins: [
            SwaggerUIBundle.plugins.DownloadUrl
          ],
          layout: "StandaloneLayout"
        })
        window.ui = ui

        console.log('Done initializing SwaggerUI', ui)

        // ui.initOAuth({
        //   clientId: "your-client-id",
        //   clientSecret: "your-client-secret-if-required",
        //   realm: "your-realms",
        //   appName: "your-app-name",
        //   scopeSeparator: " ",
        //   additionalQueryStringParams: {}
        // })

        return ui
      }

      // Get spec from Confluence or start empty
      // TODO check if AP is even defined
      if (AP && AP.confluence) {
        // Recover macro editor state
        // AP.confluence.getMacroData((macroParams) => {
        //   console.log('Recovering state from Confluence')
        //   console.log('Confluence macroParams is', macroParams)
        //   if (macroParams && macroParams.spec) {
        //     console.log('Spec is', macroParams.spec)
        //     start(macroParams.spec)
        //   }
        // })

        console.log('Recovering state from Confluence')
        var pageId = getUrlParameter("pageId")
        var pageVersion = getUrlParameter("pageVersion")
        var macroId = getUrlParameter("macroId")
        console.log('pageId', pageId, 'pageVersion', pageVersion, 'macroId', macroId)
        AP.request({
          url: "/rest/api/content/" + pageId +
          "/history/" + pageVersion +
          "/macro/id/" + macroId,
          success: function(response) {
            var macroParams = JSON.parse(response)
            console.log('Macro params are', macroParams)
            // start(YAML.parse(macroParams.parameters.spec.value))
            start(YAML.parse(macroParams.body))
          },
          error: function(xhr, statusText, errorThrown) {
            console.log('Failed to get macro params', xhr, statusText, errorThrown)
          }
        });

      } else {
        start({})
      }
    }
  </script>
</body>

</html>
